// src/components/Header.jsx

import React from 'react';
import {
  AppBar,
  Toolbar,
  Box,
  Typography,
  Select,
  MenuItem,
  IconButton
} from '@mui/material';
import { useNavigate, useLocation } from 'react-router-dom';

import HomeIcon        from '@mui/icons-material/Home';
import HistoryIcon     from '@mui/icons-material/History';
import ListAltIcon     from '@mui/icons-material/ListAlt';

import WuLogo from '../assets/wu-logo.png';
import CostaRicaFlag from '../assets/flags/costa-rica.png';
import ArgentinaFlag  from '../assets/flags/argentina.png';
import MexicoFlag     from '../assets/flags/mexico.png';
import PeruFlag       from '../assets/flags/peru.png';
import BrazilFlag     from '../assets/flags/brazil.png';
import PanamaFlag     from '../assets/flags/panama.png';
import LacaFlag       from '../assets/laca-flag.png';
import { partitionList } from '../services/occupancy.service';

export default function Header() {
  const navigate = useNavigate();
  const loc = useLocation();

  // Path segments: e.g. ['partition','CR.Costa...','history']
  const parts = loc.pathname.split('/').filter(Boolean);
  const isPartitionPath = parts[0] === 'partition' && Boolean(parts[1]);
  const currentPartition = isPartitionPath ? decodeURIComponent(parts[1]) : '';
  const suffixSegments = isPartitionPath
    ? parts.slice(2)
    : parts[0] === 'history'
      ? ['history']
      : [];

  const flagMap = {
    'CR.Costa Rica Partition': CostaRicaFlag,
    'AR.Cordoba':               ArgentinaFlag,
    'MX.Mexico City':           MexicoFlag,
    'PE.Lima':                  PeruFlag,
    'BR.Sao Paulo':             BrazilFlag,
    'PA.Panama City':           PanamaFlag,
  };
  const selectedFlag = flagMap[currentPartition] || LacaFlag;

  // Helper to build partition-scoped paths with suffix
  const makePartitionPath = (suffix) => {
    const base = `/partition/${encodeURIComponent(currentPartition)}`;
    return suffix
      ? `${base}/${suffix}`
      : base;
  };

  const handlePartitionChange = (newPartition) => {
    if (!newPartition) return navigate('/');
    const base = `/partition/${encodeURIComponent(newPartition)}`;
    const full = suffixSegments.length
      ? `${base}/${suffixSegments.join('/')}`
      : base;
    navigate(full);
  };

  return (
    <AppBar position="static" color="primary" sx={{ mb: 2 }}>
      <Toolbar sx={{ justifyContent: 'space-between' }}>
        {/* Left side: Logo, Title, Navigation Icons */}
        <Box display="flex" alignItems="center" sx={{ flexGrow: 1 }}>
          <Box component="img" src={WuLogo} alt="WU Logo" sx={{ height: 36, mr: 2 }} />

          <Typography variant="h6" sx={{ fontWeight: 600, mr: 3 }}>
            Western Union – LACA
            {currentPartition && (
              <> • {currentPartition.replace('CR.Costa Rica Partition','Costa Rica')}</>
            )}
          </Typography>

          {/* Dashboard Icon */}
          <IconButton
            size="large"
            color="inherit"
            onClick={() => {
              const target = currentPartition
                ? `/partition/${encodeURIComponent(currentPartition)}`
                : '/';
              navigate(target);
            }}
          >
            <HomeIcon />
          </IconButton>

          {/* History Icon */}
          <IconButton
            size="large"
            color="inherit"
            onClick={() => {
              const target = currentPartition
                ? makePartitionPath('history')
                : '/history';
              navigate(target);
            }}
          >
            <HistoryIcon />
          </IconButton>

          {/* Details Icon (only when in partition context) */}
          {currentPartition && (
            <IconButton
              size="large"
              color="inherit"
              onClick={() => navigate(makePartitionPath('details'))}
            >
              <ListAltIcon />
            </IconButton>
          )}
        </Box>

        {/* Right side: Partition selector + Flag */}
        <Box display="flex" alignItems="center">
          <Select
            size="small"
            value={currentPartition}
            displayEmpty
            onChange={e => handlePartitionChange(e.target.value)}
            sx={{ bgcolor: 'background.paper', mr: 2 }}
          >
            <MenuItem value="">— Select Partition —</MenuItem>
            {partitionList.map(p => (
              <MenuItem key={p} value={p}>
                {p.replace('Partition', '')}
              </MenuItem>
            ))}
          </Select>
          <Box component="img" src={selectedFlag} alt="Flag" sx={{ height: 50 }} />
        </Box>
      </Toolbar>
    </AppBar>
  );
}






// src/components/Header.jsx

import React from 'react';
import { AppBar, Toolbar, Box, Typography, Select, MenuItem } from '@mui/material';
import { useNavigate, useLocation } from 'react-router-dom';

import WuLogo from '../assets/wu-logo.png';
import CostaRicaFlag from '../assets/flags/costa-rica.png';
import ArgentinaFlag   from '../assets/flags/argentina.png';
import MexicoFlag      from '../assets/flags/mexico.png';
import PeruFlag        from '../assets/flags/peru.png';
import BrazilFlag      from '../assets/flags/brazil.png';
import PanamaFlag      from '../assets/flags/panama.png';
import LacaFlag        from '../assets/laca-flag.png';
import { partitionList } from '../services/occupancy.service';

export default function Header() {
  const navigate = useNavigate();
  const loc = useLocation();

  // Split the current path into segments.
  const parts = loc.pathname.split('/').filter(Boolean);
  // parts[0] === 'partition'? then parts[1] is the partition name
  // const isPartitionPath = parts[0] === 'partition' && parts[1];
   const isPartitionPath = parts[0] === 'partition' && Boolean(parts[1]);
  const currentPartition = isPartitionPath ? decodeURIComponent(parts[1]) : '';
  // Any remaining segments after /partition/:partition
  // const suffixSegments = isPartitionPath ? parts.slice(2) : [];

 // Capture any “sub-page” suffix — either after partition OR standalone `/history`
 const suffixSegments = isPartitionPath
   ? parts.slice(2)               // e.g. ['history'] when on /partition/.../history
   : parts[0] === 'history'       // if just "/history"
     ? ['history']
     : [];

  // e.g. ['history'] or ['details'] or []

  // Map partition string → flag
  const flagMap = {
    'CR.Costa Rica Partition': CostaRicaFlag,
    'AR.Cordoba':              ArgentinaFlag,
    'MX.Mexico City':          MexicoFlag,
    'PE.Lima':                 PeruFlag,
    'BR.Sao Paulo':            BrazilFlag,
    'PA.Panama City':          PanamaFlag,
  };
  const selectedFlag = flagMap[currentPartition] || LacaFlag;

  const handlePartitionChange = (newPartition) => {
    if (!newPartition) {
      // Go home if they clear selection
      return navigate('/');
    }
    // Base for new partition
    const base = `/partition/${encodeURIComponent(newPartition)}`;
    // Reattach any suffix (e.g. "history" or "details")
    const full = suffixSegments.length
      ? `${base}/${suffixSegments.join('/')}`
      : base;
    navigate(full);
  };

  return (
    <AppBar position="static" color="primary" sx={{ mb: 2 }}>
      <Toolbar sx={{ justifyContent: 'space-between' }}>
        <Box display="flex" alignItems="center">
          <Box component="img" src={WuLogo} alt="WU Logo" sx={{ height: 36, mr: 2 }} />
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Western Union – LACA
            {currentPartition && (
              <> • {currentPartition.replace('CR.Costa Rica Partition','Costa Rica')}</>
            )}
          </Typography>
        </Box>
        <Box display="flex" alignItems="center">
          <Select
            size="small"
            value={currentPartition}
            displayEmpty
            onChange={e => handlePartitionChange(e.target.value)}
            sx={{ bgcolor: 'background.paper', mr: 2 }}
          >
            <MenuItem value="">— Select Partition —</MenuItem>
            {partitionList.map(p => (
              <MenuItem key={p} value={p}>
                {p.replace('Partition', '')}
              </MenuItem>
            ))}
          </Select>
          <Box component="img" src={selectedFlag} alt="Flag" sx={{ height: 50 }} />
        </Box>
      </Toolbar>
    </AppBar>
  );
}
